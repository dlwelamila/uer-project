generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id           String        @id @default(cuid())
  name         String        @unique
  createdAt    DateTime      @default(now())
  contacts     Contact[]
  engagements  Engagement[]
  environments Environment[]
}

model Environment {
  id             String       @id @default(cuid())
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  systems        System[]
}

model Engagement {
  id             String        @id @default(cuid())
  organizationId String
  type           String
  periodStart    DateTime
  periodEnd      DateTime
  status         String        @default("Draft")
  channelStats   ChannelStat[]
  organization   Organization  @relation(fields: [organizationId], references: [id])
  evidence       Evidence[]    @relation("EngagementEvidence")
  incidents      Incident[]
  notes          Note[]
  sessions       Session[]
  volumePoints   VolumePoint[]
}

model Session {
  id           String     @id @default(cuid())
  engagementId String
  medium       String
  scheduledAt  DateTime?
  startedAt    DateTime?
  endedAt      DateTime?
  attendees    String?
  notes        String?
  evidence     Evidence[] @relation("SessionEvidence")
  engagement   Engagement @relation(fields: [engagementId], references: [id])
}

model Evidence {
  id           String       @id @default(cuid())
  engagementId String
  sessionId    String?
  sectionKey   String
  filePath     String
  originalName String
  takenAt      DateTime?
  takenBy      String?
  environment  String?
  redaction    String?
  extra        Json?
  createdAt    DateTime     @default(now())
  engagement   Engagement   @relation("EngagementEvidence", fields: [engagementId], references: [id])
  session      Session?     @relation("SessionEvidence", fields: [sessionId], references: [id])
  extractions  Extraction[]
}

model Extraction {
  id          String    @id @default(cuid())
  evidenceId  String
  fieldKey    String
  rawText     String?
  parsedValue String?
  confidence  Float?
  verifiedBy  String?
  verifiedAt  DateTime?
  evidence    Evidence  @relation(fields: [evidenceId], references: [id])
}

model Note {
  id           String     @id @default(cuid())
  engagementId String
  sectionKey   String
  text         String
  author       String?
  createdAt    DateTime   @default(now())
  engagement   Engagement @relation(fields: [engagementId], references: [id])
}

model ProductFamily {
  id     String         @id @default(cuid())
  name   String         @unique
  models ProductModel[]
}

model ProductModel {
  id       String        @id @default(cuid())
  name     String
  familyId String
  family   ProductFamily @relation(fields: [familyId], references: [id])
  systems  System[]
}

model System {
  id              String           @id @default(cuid())
  displayName     String
  serial          String?
  installedCode   String?
  status          String?
  environmentId   String?
  modelId         String?
  incidents       Incident[]
  serviceRequests ServiceRequest[]
  sparePartEvents SparePartEvent[] @relation("SystemSpareParts")
  environment     Environment?     @relation(fields: [environmentId], references: [id])
  model           ProductModel?    @relation(fields: [modelId], references: [id])
}

model ServiceRequest {
  id        String    @id @default(cuid())
  systemId  String?
  severity  Int
  channel   String
  createdAt DateTime
  closedAt  DateTime?
  status    String
  system    System?   @relation(fields: [systemId], references: [id])
}

model Incident {
  id             String      @id @default(cuid())
  systemId       String?
  codeLevel      String?
  summary        String
  createdAt      DateTime
  resolvedAt     DateTime?
  closedAt       DateTime?
  status         String      @default("Open")
  impact         String?
  resolution     String?
  recommendation String?
  createdTs      DateTime    @default(now())
  updatedTs      DateTime    @updatedAt
  engagementId   String?
  sn             String?
  srNumber       String?
  systemName     String?
  engagement     Engagement? @relation(fields: [engagementId], references: [id])
  system         System?     @relation(fields: [systemId], references: [id])
}

model SparePartEvent {
  id       String   @id @default(cuid())
  systemId String?
  date     DateTime
  srNumber String?
  partType String
  quantity Int      @default(1)
  mode     String?
  status   String?
  system   System?  @relation("SystemSpareParts", fields: [systemId], references: [id])
}

model ChannelStat {
  id           String     @id @default(cuid())
  engagementId String
  channel      String
  percent      Float
  engagement   Engagement @relation(fields: [engagementId], references: [id])
}

model VolumePoint {
  id           String     @id @default(cuid())
  engagementId String
  month        Int
  year         Int
  value        Int
  engagement   Engagement @relation(fields: [engagementId], references: [id])
}

model Gateway {
  id               String    @id @default(cuid())
  gatewayId        String
  model            String?
  version          String?
  connectedDevices Int       @default(0)
  lastContact      DateTime?
  registered       DateTime?
  clusterId        String?
  clusterName      String?
}

model CodePolicyTrack {
  id          String  @id @default(cuid())
  systemModel String
  assetCount  Int     @default(0)
  x7Min       String?
  x7Rec       String?
  x7Latest    String?
  x8Min       String?
  x8Rec       String?
  x8Latest    String?
  installed   String?
  marker      String?
}

model Contract {
  id           String    @id @default(cuid())
  product      String?
  startDate    DateTime?
  endDate      DateTime
  statusBucket String
}

model Risk {
  id          String  @id @default(cuid())
  category    String
  description String
  priority    String
  probDU      String?
  owner       String
  status      String
  due         String?
  mitigation  String?
}

model ActionItem {
  id     String  @id @default(cuid())
  action String
  owner  String
  status String
  due    String?
  notes  String?
}

model Contact {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  role           String?
  phone          String?
  email          String?
  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Engineer {
  id             String                  @id @default(cuid())
  name           String                  @unique
  role           String?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  certifications EngineerCertification[]
  oemAssignments OemComplianceAssignment[]
  trainingRecords EngineerTraining[]
}

model EngineerCertification {
  id             String    @id @default(cuid())
  engineerId     String
  certification  String
  vendor         String
  domain         String?
  year           Int?
  expires        DateTime?
  status         String
  statusDetail   String?
  notExpiring    Boolean   @default(false)
  attachmentPath String?
  attachmentName String?
  attachmentMime String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  engineer       Engineer  @relation(fields: [engineerId], references: [id], onDelete: Cascade)
  oemAssignments OemComplianceAssignment[]

  @@unique([engineerId, certification, vendor])
  @@index([engineerId])
  @@index([vendor])
}

model EngineerTraining {
  id              String          @id @default(cuid())
  engineerId      String
  vendor          String
  module          String
  domain          String?
  progressPercent Int             @default(0)
  timeline        String?
  status          TrainingStatus  @default(IN_PROGRESS)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  engineer        Engineer        @relation(fields: [engineerId], references: [id], onDelete: Cascade)

  @@unique([engineerId, module])
  @@index([engineerId])
  @@index([vendor])
  @@index([status])
}

model EnablementProgram {
  id             String           @id @default(cuid())
  vendor         String
  specialization String
  role           EnablementRole
  keywords       String[]         @default([])
  activeYear     Int
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([vendor, specialization, role], name: "vendor_specialization_role")
}

model OemComplianceTrack {
  id                 String                   @id @default(cuid())
  oem                String
  specialization     String
  requiredCerts      Int                      @default(0)
  earnedCerts        Int                      @default(0)
  overallRequirement Int
  overallEarned      Int                      @default(0)
  complianceStatus   OemComplianceStatus      @default(PENDING)
  targetDate         DateTime?
  roadmapNotes       String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  assignments        OemComplianceAssignment[]

  @@unique([oem, specialization], name: "oem_specialization")
  @@index([oem])
  @@index([complianceStatus])
}

model OemComplianceAssignment {
  id                String               @id @default(cuid())
  trackId           String
  engineerId        String
  certificationName String
  status            OemAssignmentStatus  @default(PENDING)
  startedAt         DateTime?
  completedAt       DateTime?
  dueAt             DateTime?
  certificationId   String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  track             OemComplianceTrack   @relation(fields: [trackId], references: [id], onDelete: Cascade)
  engineer          Engineer             @relation(fields: [engineerId], references: [id], onDelete: Cascade)
  certification     EngineerCertification? @relation(fields: [certificationId], references: [id])

  @@unique([trackId, engineerId, certificationName], name: "trackId_engineerId_certificationName")
  @@index([trackId])
  @@index([engineerId])
  @@index([status])
  @@index([certificationId])
}

model ProjectAccount {
  id           String                  @id @default(cuid())
  name         String                  @unique
  industry     String?
  region       String?
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  projects     Project[]
  managerLinks ProjectManagerAccount[]
}

model ProjectManager {
  id           String                  @id @default(cuid())
  name         String
  email        String?
  phone        String?
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  projects     Project[]
  accountLinks ProjectManagerAccount[]
}

model ProjectManagerAccount {
  id        String         @id @default(cuid())
  managerId String
  accountId String
  createdAt DateTime       @default(now())
  account   ProjectAccount @relation(fields: [accountId], references: [id])
  manager   ProjectManager @relation(fields: [managerId], references: [id])

  @@unique([managerId, accountId])
}

model Project {
  id          String         @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus  @default(ONGOING)
  progress    Int            @default(0)
  dueDate     DateTime?
  accountId   String
  managerId   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  account     ProjectAccount @relation(fields: [accountId], references: [id])
  manager     ProjectManager @relation(fields: [managerId], references: [id])
  cases       ProjectCase[]
  tasks       ProjectTask[]

  @@unique([name, accountId])
}

model ProjectTask {
  id          String            @id @default(cuid())
  projectId   String
  title       String
  status      ProjectTaskStatus @default(TODO)
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  project     Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, title])
}

model ProjectCase {
  id         String            @id @default(cuid())
  projectId  String
  summary    String
  status     ProjectCaseStatus @default(OPEN)
  openedAt   DateTime          @default(now())
  resolvedAt DateTime?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, summary])
}

model SalesLead {
  id             String   @id @default(cuid())
  name           String
  company        String
  email          String?
  phone          String?
  manager        String?
  status         String   @default("New Lead")
  estimatedValue Int?
  probability    Int?
  sector         String?
  region         String?
  source         String?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([name, company])
  @@index([company])
  @@index([status])
}

model SalesTarget {
  id          String            @id @default(cuid())
  period      SalesTargetPeriod
  amount      Int
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([period, periodStart, periodEnd])
  @@index([period, periodStart])
  @@index([period, periodEnd])
}

model Tender {
  id                 String         @id @default(cuid())
  name               String
  entity             String
  status             TenderStatus   @default(ONGOING)
  submissionDate     DateTime?
  advertisedDate     DateTime?
  submissionDateTime DateTime?
  tenderNumber       String?
  value              Int?
  owner              String?
  comment            String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  workflows          TenderWorkflowTask[]

  @@index([status])
  @@index([submissionDate])
  @@index([entity])
}

model TenderWorkflowTask {
  id        String       @id @default(cuid())
  tenderId  String
  stage     String
  keyTask   String?
  timeline  String?
  owner     String?
  status    TenderStatus @default(PENDING)
  note      String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  tender    Tender       @relation(fields: [tenderId], references: [id], onDelete: Cascade)

  @@index([tenderId])
  @@index([status])
}

model TenderHistory {
  id        String   @id @default(cuid())
  year      Int
  total     Int
  won       Int
  lost      Int
  ongoing   Int
  valueWon  Decimal @db.Decimal(20, 0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year])
}

enum ProjectStatus {
  UPCOMING
  ONGOING
  COMPLETED
  BLOCKED
  ON_HOLD
}

enum ProjectTaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum ProjectCaseStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum SalesTargetPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum TenderStatus {
  WON
  LOST
  ONGOING
  PENDING
  SUBMITTED
  IN_REVIEW
}

enum TrainingStatus {
  IN_PROGRESS
  COMPLETED
  NOT_STARTED
}

enum EnablementRole {
  SALES
  SYSTEMS_ENGINEER
}

enum OemComplianceStatus {
  ON_TRACK
  PENDING
  AT_RISK
}

enum OemAssignmentStatus {
  EARNED
  ONGOING
  PENDING
}
